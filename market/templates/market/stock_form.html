{% extends "market/base.html" %}
{% block title %}Generate Stock Chart{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-6">

    <form method="get" action="{% url 'market:stock_chart' %}">
      <!-- Symbol Search -->
      <div class="mb-3">
        <label for="symbol-search" class="form-label">Search Symbol</label>
        <input
          type="text"
          id="symbol-search"
          class="form-control"
          placeholder="Type to filterâ€¦"
        >
      </div>

      <!-- Symbol Select -->
      <div class="mb-3">
        <label for="symbol-select" class="form-label">Symbol</label>
        <select
          name="symbol"
          id="symbol-select"
          class="form-select"
          size="5"
        >
          {% for sym in instrument_list %}
            <option
              value="{{ sym.symbol }}"
              data-security-id="{{ sym.security_id }}"
            >
              {{ sym.symbol }}
            </option>
          {% endfor %}
        </select>
      </div>
      <input type="hidden" name="security_id" id="security-id">

      <!-- Start Price -->
      <div class="mb-3">
        <label for="start_price_select" class="form-label">Start Price</label>
        <select
          name="start_price"
          id="start_price_select"
          class="form-select"
        >
          <option value="open">Open</option>
          <option value="high">High</option>
          <option value="low">Low</option>
          <option value="close">Close</option>
        </select>
      </div>

      <!-- Start Date -->
      <div class="mb-3">
        <label for="start_date" class="form-label">Bar Index Start Date</label>
        <input
          type="date"
          name="start_date"
          id="start_date"
          class="form-control"
          required
        >
      </div>

      <!-- Price-to-Bar Ratio -->
      <div class="mb-3">
        <label for="price_to_bar_ratio" class="form-label">Price-to-Bar Ratio</label>
        <input
          type="number"
          name="price_to_bar_ratio"
          id="price_to_bar_ratio"
          class="form-control"
          required
        >
      </div>

      <!-- Angles -->
      <div class="mb-3">
        <label for="angles" class="form-label">Angles (comma-sep)</label>
        <input
          type="text"
          name="angles"
          id="angles"
          class="form-control"
          value="45,63.25"
        >
      </div>

      <button type="submit" class="btn btn-primary">Generate Chart</button>
      <br>
      <br>
      <br>
    </form>

    {% if request.GET %}
      <div class="mt-4">
        <h3>Chart for {{ request.GET.symbol }}</h3>
        <img
          src="{% url 'market:stock_chart' %}?{{ request.GET.urlencode }}"
          class="img-fluid border"
          alt="Stock chart"
        >
      </div>
    {% endif %}

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('symbol-search');
  const selectEl    = document.getElementById('symbol-select');
  const hiddenInput = document.getElementById('security-id');

  // 1) Filter the dropdown as you type
  searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    Array.from(selectEl.options).forEach(opt => {
      opt.hidden = !opt.text.toLowerCase().includes(filter);
    });
  });

  // 2) Sync the hidden security_id field
  function updateSecurityId() {
    const sel = selectEl.options[ selectEl.selectedIndex ];
    hiddenInput.value = sel?.dataset.securityId || '';
  }
  selectEl.addEventListener('change', updateSecurityId);

  // 3) Initialize on load
  if (selectEl.selectedIndex >= 0) updateSecurityId();
});
</script>
{% endblock %}

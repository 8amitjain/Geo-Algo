{# templates/market/trendline_list.html #}
{% extends "market/base.html" %}
{% block title %}Trend Lines{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
  <h1 class="mb-4">Trend Lines</h1>

  <!-- FILTER FORM -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Symbol</label>
      <input
        type="text"
        name="symbol"
        value="{{ filters.symbol }}"
        class="form-control"
        placeholder="e.g. TCS"
      >
    </div>
    <div class="col-md-2">
      <label class="form-label">Angle</label>
      <input
        type="text"
        name="angle"
        value="{{ filters.angle }}"
        class="form-control"
        placeholder="e.g. 45"
      >
    </div>
    <div class="col-md-2">
      <label class="form-label">Start Date</label>
      <input
        type="date"
        name="start_date"
        value="{{ filters.start_date }}"
        class="form-control"
      >
    </div>
    <div class="col-md-2">
      <label class="form-label">Created At</label>
      <input
        type="date"
        name="created_at"
        value="{{ filters.created_at }}"
        class="form-control"
      >
    </div>
    <div class="col-md-2">
      <label class="form-label">Touched?</label>
      <select name="touched" class="form-select">
        <option value="">Any</option>
        <option value="yes" {% if filters.touched == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no"  {% if filters.touched == 'no'  %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Purchased?</label>
      <select name="purchased" class="form-select">
        <option value="">Any</option>
        <option value="yes" {% if filters.purchased == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no"  {% if filters.purchased == 'no'  %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <!-- RESULTS TABLE -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Symbol</th>
          <th>Start Date</th>
          <th>Angles (°)</th>
          <th>Ratio</th>
          <th>Created</th>
          <th>Touched?</th>
          <th>Purchased?</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for tl in trendlines %}
          <tr>
            <td>{{ tl.symbol }}</td>
            <td>{{ tl.start_date }}</td>
            <td>{{ tl.angles|join:", " }}</td>
            <td>{{ tl.price_to_bar_ratio }}</td>
            <td>{{ tl.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              {% if tl.is_touched %}
                ✔
              {% else %}
                ✘
              {% endif %}
            </td>
            <td>
              {% if tl.is_purchased %}
                ✔
              {% else %}
                ✘
              {% endif %}
            </td>
            <td>
              <a
                href="{% url 'market:stock_chart' %}?symbol={{ tl.symbol|urlencode }}&security_id={{ tl.security_id }}&start_price=low&start_date={{ tl.start_date }}&price_to_bar_ratio={{ tl.price_to_bar_ratio }}&angles={{ tl.angles|join:',' }}"
                class="btn btn-sm btn-outline-primary"
              >View Chart</a>

              <a
                href="{% url 'market:stock_chart_ema' %}?symbol={{ tl.symbol|urlencode }}&security_id={{ tl.security_id }}&interval=15&date={{ tl.start_date }}"
                class="btn btn-sm btn-outline-secondary"
              >View EMA Crossover</a>
            </td>
<!--            <td>-->
<!--              &lt;!&ndash; Add Buy & Sell buttons &ndash;&gt;-->
<!--              <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#buyModal"-->
<!--                      data-symbol="{{ tl.symbol }}"-->
<!--                      data-security_id="{{ tl.security_id }}">-->
<!--                Buy-->
<!--              </button>-->
<!--              <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#sellModal"-->
<!--                      data-symbol="{{ tl.symbol }}"-->
<!--                      data-security_id="{{ tl.security_id }}">-->
<!--                Sell-->
<!--              </button>-->
<!--            </td>-->
          </tr>
        {% empty %}
          <tr>
            <td colspan="8" class="text-center">No trend lines found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Buy Modal -->
<div class="modal fade" id="buyModal" tabindex="-1" aria-labelledby="buyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{% url 'market:buy_stock' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="buyModalLabel">Buy Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="security_id" id="buy-security-id">
          <input type="hidden" name="symbol" id="buy-symbol">
          <div class="mb-3">
            <label for="risk_per_unit" class="form-label">Risk Per Unit</label>
            <input type="number" step="0.01" name="risk_per_unit" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="cross_price" class="form-label">Cross Price</label>
            <input type="number" step="0.01" name="cross_price" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Confirm Buy</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const buyModal = document.getElementById('buyModal');
  buyModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const securityId = button.getAttribute('data-security_id');
    const symbol = button.getAttribute('data-symbol');
    buyModal.querySelector('#buy-security-id').value = securityId;
    buyModal.querySelector('#buy-symbol').value = symbol;
  });
</script>


{% endblock %}
